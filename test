-- Assign peripherals by side
local colony_integrator = peripheral.wrap("top")
local me_bridge = peripheral.wrap("bottom")

if not colony_integrator then error("No Colony Integrator found on top!") end
if not me_bridge then error("No ME Bridge found on bottom!") end

-- Pause interval between scans
local SCAN_INTERVAL = 10

-- Debug helper
local DEBUG = true
local function dprint(...)
    if DEBUG then print("[DEBUG]", ...) end
end

-- Export an item to any connected inventory
local function exportItem(itemName, count)
    local stack = { name = itemName, count = count or 1 }
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        local ok, result = pcall(function()
            return me_bridge.exportItem(stack, side)
        end)
        if ok and type(result) == "number" and result > 0 then
            dprint("Exported " .. result .. " x " .. itemName .. " to side " .. side)
            return result
        end
    end
    dprint("Failed to export " .. itemName .. ": no output inventory found")
    return 0
end

-- Main loop
while true do
    local requests = colony_integrator.getRequests()
    if requests then
        -- Loop through requests multiple times to try and fulfill fully
        for _, req in ipairs(requests) do
            local reqItem = req.items[1].name
            local reqCount = req.count
            local reqTarget = req.target or ""

            if string.find(reqTarget, "Ezra") then
                local remaining = reqCount
                while remaining > 0 do
                    local exported = exportItem(reqItem, remaining)
                    remaining = remaining - exported
                    if exported == 0 then
                        dprint("Waiting for AE2 stock for " .. reqItem)
                        break
                    end
                end
                dprint(string.format("Finished processing %d x %s for Ezra", reqCount, reqItem))
            end
        end
    else
        dprint("No requests found from Colony Integrator.")
    end

    sleep(SCAN_INTERVAL)
end
