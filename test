-- Wrap peripherals
local colony_integrator = peripheral.wrap("top")
if not colony_integrator then
    error("No colony integrator found on top")
end

local me_bridge = peripheral.wrap("bottom")
if not me_bridge then
    error("No ME Bridge found on bottom")
end

-- Safe export function (using the earlier tested method)
local function safeExportItem(stack)
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        local ok, exported = pcall(function()
            return me_bridge.exportItem(stack, side)
        end)
        if ok and exported > 0 then
            print("Exported " .. exported .. "x " .. stack.name .. " to side: " .. side)
            return exported
        end
    end
    print("Failed to export " .. stack.name .. ": no output inventory found")
    return 0
end

-- Main loop
while true do
    local allRequests = colony_integrator.getRequests() or {} -- safe fallback
    print("Found " .. #allRequests .. " requests")

    for _, req in ipairs(allRequests) do
        -- Only process requests for Ezra's Builder Hut
        if req.target:find("Builder") then
            local itemName = req.items[1].name
            local countNeeded = req.count

            -- Get current AE2 count
            local aeItems = me_bridge.listItems() or {}
            local available = 0
            for _, item in ipairs(aeItems) do
                if item.name == itemName then
                    available = item.count or 0
                    break
                end
            end

            if available > 0 then
                local toExport = math.min(available, countNeeded)
                local exported = safeExportItem({ name = itemName, count = toExport })
                print("Attempted to export " .. toExport .. " of " .. itemName .. ", actually exported: " .. exported)
            else
                print("No " .. itemName .. " available in AE2")
            end
        end
    end

    print("Cycle complete, waiting 10 seconds...")
    sleep(10)
end
