local colony_integrator = peripheral.wrap("top")
local me_bridge        = peripheral.wrap("bottom")
local chest_side       = "back"  -- side of the chest

if not colony_integrator then error("No Colony Integrator on top!") end
if not me_bridge then error("No ME Bridge on bottom!") end

-- Export requested items
local function exportItem(itemName, count)
    local exported = me_bridge.exportItem({name=itemName, count=count}, chest_side)
    print("Exported " .. exported .. "x " .. itemName)
    return exported
end

-- Return unrequested items to AE2
local function returnUnrequested(requestedItems)
    local items = peripheral.call(chest_side, "list") or {}
    for slot, item in pairs(items) do
        if not requestedItems[item.name] then
            local returned = me_bridge.exportItem({name=item.name, count=item.count}, "bottom") -- back to AE2
            print("Returned " .. returned .. "x " .. item.name)
        end
    end
end

while true do
    local requests = colony_integrator.getRequests() or {}
    local requestedItems = {}

    for _, req in ipairs(requests) do
        for _, item in ipairs(req.items) do
            requestedItems[item.name] = (requestedItems[item.name] or 0) + req.count
        end
    end

    for itemName, count in pairs(requestedItems) do
        exportItem(itemName, count)
    end

    returnUnrequested(requestedItems)
    sleep(10)
end
