-- Assign peripherals by side
local colony_integrator = peripheral.wrap("top")
local me_bridge = peripheral.wrap("bottom")

if not colony_integrator then error("No Colony Integrator found on top!") end
if not me_bridge then error("No ME Bridge found on bottom!") end

-- Pause interval between scans
local SCAN_INTERVAL = 10

-- Helper debug print
local DEBUG = true
local function dprint(...)
    if DEBUG then print("[DEBUG]", ...) end
end

-- Attempt to export an item to any connected inventory on the ME Bridge
local function exportItem(itemName, count)
    local stack = { name = itemName, count = count or 1 }
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        local ok, result = pcall(function()
            return me_bridge.exportItem(stack, side)
        end)
        if ok and type(result) == "number" and result > 0 then
            dprint("Exported " .. result .. " x " .. itemName .. " to side " .. side)
            return result
        end
    end
    dprint("Failed to export " .. itemName .. ": no output inventory found")
    return 0
end

-- Main loop: check requests and fulfill them
while true do
    local requests = colony_integrator.getRequests()
    if requests then
        for _, req in ipairs(requests) do
            local reqName = req.name
            local reqItem = req.items[1].name
            local reqCount = req.count
            local provided = 0

            -- Check available in AE2
            local aeItems = me_bridge.listItems() or {}
            local available = 0
            for _, data in ipairs(aeItems) do
                if data.name == reqItem then
                    available = data.count or 0
                    break
                end
            end

            if available > 0 then
                local toExport = math.min(reqCount, available)
                local actuallyExported = exportItem(reqItem, toExport)
                provided = provided + actuallyExported
            end

            dprint(string.format("Request: %d/%d %s provided", provided, reqCount, reqItem))
        end
    else
        dprint("No requests found from Colony Integrator.")
    end

    -- Wait before next scan
    sleep(SCAN_INTERVAL)
end
