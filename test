-- Setup peripherals
local colony_integrator = peripheral.wrap("top")
local me_bridge = peripheral.wrap("bottom")
local chest = peripheral.find("inventory")  -- barrel/chest connected

if not colony_integrator then error("No colony integrator found on top") end
if not me_bridge then error("No ME Bridge found on bottom") end
if not chest then error("No chest/barrel found") end

-- Logging helper (keeps output within 18 lines)
local logLines = {}
local function log(msg)
    table.insert(logLines, msg)
    if #logLines > 18 then
        table.remove(logLines, 1)
    end
    term.clear()
    term.setCursorPos(1,1)
    for i, line in ipairs(logLines) do
        print(line)
    end
end

-- Safe export from ME Bridge to chest
local function exportItem(stack)
    log("Attempting export: "..stack.name.." x"..(stack.count or 1))
    local itemStack = {name = stack.name, count = stack.count or 1}
    local sides = {"top","bottom","left","right","front","back"}
    for _, side in ipairs(sides) do
        local ok, exported = pcall(function()
            return me_bridge.exportItem(itemStack, side)
        end)
        if ok and exported > 0 then
            log(string.format("Exported %d/%d of %s to %s", exported, itemStack.count, stack.name, side))
            return exported
        elseif not ok then
            log("Error exporting "..stack.name..": "..tostring(exported))
        end
    end
    log("Failed to export "..stack.name)
    return 0
end

-- Get Ezra's Builder Hut requests
local function getEzraRequests()
    local allRequests = colony_integrator.getRequests()
    if not allRequests then
        log("No requests returned from integrator")
        return {}
    end
    local ezraRequests = {}
    for _, req in ipairs(allRequests) do
        if req.target and req.target:match("Builder Ezra") then
            table.insert(ezraRequests, req)
        end
    end
    log("Found "..#ezraRequests.." requests for Builder Ezra")
    return ezraRequests
end

-- Process Ezra's requests
local function processRequests()
    local requests = getEzraRequests()
    for _, req in ipairs(requests) do
        local item = req.items[1].name
        local needed = req.count
        local exported = exportItem({name=item, count=needed})
        log(string.format("Requested %d of %s, exported %d", needed, item, exported))
    end
end

-- Main loop: continuous scan
while true do
    local requests = getEzraRequests()
    if #requests > 0 then
        processRequests()
        sleep(1) -- brief pause between cycles to avoid flooding
    else
        log("No Ezra requests; waiting 10s")
        sleep(10)
    end
end
