-- Colony Integrator on TOP, ME Bridge on BOTTOM, Warehouse on LEFT
local colony = peripheral.wrap("top")
if not colony then
  error("No Colony Integrator detected on TOP — check placement!")
end

local me = peripheral.wrap("bottom")
local warehouse = peripheral.wrap("left")

local function log(msg) print(os.date("%H:%M:%S") .. " | " .. msg) end

-- Count items in AE2
local function getItemCount(name)
  local items = me.getItems() or {}
  local total = 0
  for _, it in pairs(items) do
    if it.name == name then total = total + (it.count or 0) end
  end
  return total
end

-- Check if item is craftable
local function isCraftable(name)
  local ok, result = pcall(function() return me.isItemCraftable({name=name}) end)
  return ok and result or false
end

-- Push requested items
local function pushItem(name, quota)
  local available = getItemCount(name)

  if available >= quota then
    local ok = me.exportItem({name=name, count=quota}, "left")
    log((ok and "✔ Pushed " or "✖ Failed ") .. quota .. "x " .. name)
    return
  end

  if isCraftable(name) then
    me.craftItem({name=name, count=(quota - available)})
    log("⏳ Queued craft for " .. (quota - available) .. "x " .. name)
  else
    log("⚠ Skipping " .. name .. " (not craftable, only " .. available .. " in AE2)")
  end
end

-- Main loop (push only, no warehouse scan)
while true do
  local requests = colony.getRequests() or {}
  local handled = 0
  local seen = {}

  for _, req in ipairs(requests) do
    for _, item in ipairs(req.items or {}) do
      if not seen[item.name] then
        local quota = (item.maxCount and item.maxCount == 1) and 4 or 64
        pushItem(item.name, quota)
        seen[item.name] = true
        handled = handled + 1
      end
    end
  end

  log("Loop complete, handled " .. handled .. " unique items")
  sleep(5)
end
