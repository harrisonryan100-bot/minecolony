-- Wrap peripherals
local integrator = peripheral.wrap("top")   -- Colony Integrator on top
local me_bridge  = peripheral.wrap("bottom") -- AE2 Bridge on bottom
local chest      = peripheral.wrap("back")  -- Chest on back

-- Check peripherals
if not integrator then error("No Colony Integrator found on top!") end
if not me_bridge then error("No ME Bridge found on bottom!") end
if not chest then error("No chest found on back!") end

-- Mapping builder huts to names (official API only sees 'target' type)
-- You can manually assign Ezra's hut ID or name here
local builderHutMapping = {
    ["Ezra"] = "Builder's Hut"
}

-- Export function (AE2 Bridge)
local function exportItem(itemName, count)
    local exported = me_bridge.exportItem({name=itemName, count=count}, "back")
    if exported > 0 then
        print("Exported " .. exported .. "x " .. itemName)
    else
        print("Failed to export " .. itemName)
    end
    return exported
end

-- Main loop
while true do
    -- Get all requests from integrator
    local requests = integrator.getRequests() or {}

    -- Filter only Ezra's hut requests
    local ezraRequests = {}
    for _, req in ipairs(requests) do
        -- Only include Builder's Hut requests
        if req.target == builderHutMapping["Ezra"] then
            for _, item in ipairs(req.items) do
                ezraRequests[item.name] = (ezraRequests[item.name] or 0) + req.count
            end
        end
    end

    -- Fulfill Ezra's requests
    for itemName, count in pairs(ezraRequests) do
        exportItem(itemName, count)
    end

    -- Wait before next cycle
    sleep(10)
end
