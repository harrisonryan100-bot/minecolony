-- Wrap peripherals
local colony = peripheral.wrap("top") -- Colony Integrator
local storage = peripheral.find("inventory") -- Finds any adjacent inventory (barrel/chest/ME Chest)
if not storage then
    error("No adjacent chest/barrel/ME Chest found!")
end

-- Main loop
while true do
    local requests = colony.getRequests() or {}

    for _, req in ipairs(requests) do
        -- Only Builder Hut requests
        if req.target:find("Builder") then
            local itemName = req.items[1].name
            local itemCount = req.count

            -- Check how many are in storage
            local storageItems = storage.list() -- Table of slots and item info
            local pulled = 0

            for slot, info in pairs(storageItems) do
                if info.name == itemName and pulled < itemCount then
                    local toPull = math.min(info.count, itemCount - pulled)
                    local success = storage.pushItems(peripheral.getName(storage), slot, toPull)
                    if success then
                        pulled = pulled + toPull
                        print(string.format("Moved %d x %s to Builder Hut", toPull, itemName))
                    end
                end
            end

            if pulled < itemCount then
                print(string.format("Warning: Could only move %d/%d x %s", pulled, itemCount, itemName))
            end
        end
    end

    sleep(10) -- Wait 10 seconds before scanning again
end
