-- Wrap peripherals
local colony_integrator = peripheral.wrap("top")
if not colony_integrator then error("No Colony Integrator found on top!") end

local me_bridge = peripheral.wrap("bottom")
if not me_bridge then error("No ME Bridge found on bottom!") end

local chest = peripheral.find("minecraft:chest") or peripheral.find("minecraft:barrel")
if not chest then error("No chest or barrel detected!") end

-- Helper function to export items from AE2 to chest
local function pushToChest(itemName, count)
    local sides = {"top","bottom","left","right","front","back"}
    for _, side in ipairs(sides) do
        local ok, result = pcall(function()
            return me_bridge.exportItem({name=itemName, count=count}, side)
        end)
        if ok and type(result) == "number" and result > 0 then
            print("Exported " .. result .. " x " .. itemName .. " to side " .. side)
            return result
        end
    end
    print("Failed to export " .. itemName)
    return 0
end

-- Process requests from Colony Integrator
local function processBuilderRequests()
    local requests = colony_integrator.getRequests()
    if not requests or #requests == 0 then
        print("No requests found from Colony Integrator.")
        return
    end

    for _, req in ipairs(requests) do
        local target = req.target
        if string.find(target, "Builder") then -- Only handle Ezra's Builder Hut
            for _, itemStack in ipairs(req.items) do
                local needed = req.count
                print("Processing request for " .. needed .. " x " .. itemStack.name)
                local exported = pushToChest(itemStack.name, needed)
                print("Requested: " .. needed .. ", Exported: " .. exported)
            end
        end
    end
end

-- Main loop: check every 10 seconds
while true do
    processBuilderRequests()
    sleep(10)
end
