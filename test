------------------------------------------------------------
-- AE2ColonyWarehouse (Simplified, CC:Tweaked / Advanced Peripherals Compliant)
------------------------------------------------------------

local SCAN_INTERVAL = 10  -- seconds between scans
local DEBUG = true

-- Wrap peripherals
local monitor  = peripheral.find("monitor") or error("No monitor found")
local meBridge = peripheral.find("meBridge") or peripheral.wrap("bottom") or error("No ME Bridge found")
local colony   = peripheral.find("colonyIntegrator") or peripheral.wrap("top") or error("No Colony Integrator found")
local chestSide = "back" -- inventory connected to ME Bridge

if not colony.isInColony then
    error("Colony Integrator is not inside a colony")
end

-- Debug print
local function dprint(...)
    if DEBUG then print("[DEBUG]", ...) end
end

------------------------------------------------------------
-- AE2 Helpers
------------------------------------------------------------
local function exportToChest(itemName, count)
    local stack = { name = itemName, count = count }
    local ok, exported = pcall(function() return meBridge.exportItem(stack, chestSide) end)
    if not ok or exported == 0 then
        dprint("Failed to export " .. itemName)
        return 0
    end
    dprint("Exported " .. exported .. "x " .. itemName)
    return exported
end

local function craftItem(itemName, count)
    local ok, result = pcall(function() return meBridge.craftItem({ name = itemName, count = count }) end)
    if ok then
        dprint("Scheduled craft of " .. count .. "x " .. itemName)
        return true
    else
        dprint("Failed to craft " .. itemName .. ": " .. tostring(result))
        return false
    end
end

------------------------------------------------------------
-- Colony Integrator Helpers
------------------------------------------------------------
local function getRequests()
    return colony.getRequests() or {}
end

------------------------------------------------------------
-- Fulfill All Requests
------------------------------------------------------------
local function fulfillAllRequests()
    local allRequests = getRequests()
    if #allRequests == 0 then
        dprint("No requests to fulfill")
        return
    end

    -- Fulfill each request individually
    for _, req in ipairs(allRequests) do
        local itemName = req.items[1].name
        local needed = req.count

        -- Attempt to export requested quantity
        local exported = exportToChest(itemName, needed)

        -- If not fully exported, schedule craft for missing amount
        if exported < needed then
            local missing = needed - exported
            craftItem(itemName, missing)
        end
    end
end

------------------------------------------------------------
-- Main Loop
------------------------------------------------------------
while true do
    fulfillAllRequests()
    sleep(SCAN_INTERVAL)
end
