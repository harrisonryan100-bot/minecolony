-- Reference positions
local computerPos = { x = os.getComputerPos().x, y = os.getComputerPos().y, z = os.getComputerPos().z }

-- Peripherals
local colony_integrator = peripheral.wrap("top")
if not colony_integrator then error("No colony_integrator found on top") end

local me_bridge = peripheral.wrap("bottom")
if not me_bridge then error("No me_bridge found on bottom") end

local chest = peripheral.find("minecraft:chest") or peripheral.find("minecraft:barrel")
if not chest then error("No chest or barrel found for output") end

-- Distance calculation
local function distance(pos1, pos2)
    local dx = pos1.x - pos2.x
    local dy = pos1.y - pos2.y
    local dz = pos1.z - pos2.z
    return math.sqrt(dx*dx + dy*dy + dz*dz)
end

-- Process builder requests within 5 blocks
local function processNearbyBuilders()
    local requests = colony_integrator.getRequests() or {}
    for _, req in ipairs(requests) do
        if req.target:match("Builder") then
            local hutPos = req.hutPosition
            if hutPos and distance(computerPos, hutPos) <= 5 then
                local itemName = req.items[1].name
                local itemCount = req.count

                -- Attempt to export from ME Bridge into chest
                local exported = me_bridge.exportItem({name = itemName, count = itemCount}, chest)
                print(string.format("Exported %d/%d of %s to chest", exported, itemCount, itemName))
            end
        end
    end
end

-- Main loop
while true do
    processNearbyBuilders()
    sleep(10)
end
