--------------------
-- PERIPHERAL SETUP (Updated)
--------------------
local monitor   = peripheral.find("monitor") or error("No monitor found")
local meBridge  = peripheral.find("meBridge") or peripheral.wrap("bottom") or error("No ME Bridge found")
local colony    = peripheral.find("colonyIntegrator") or peripheral.wrap("top") or error("No Colony Integrator found")

if not colony.isInColony then
    error("Colony Integrator is not inside a colony")
end

-- Output chest side (string)
local chestSide = "back"

--------------------
-- AE2 Helpers
--------------------
local function getAEItems()
    local items = meBridge.listItems() or {}
    local counts = {}
    for _, i in ipairs(items) do
        counts[i.name] = (counts[i.name] or 0) + (i.count or 0)
    end
    return counts
end

local function exportToChest(itemName, count)
    local stack = { name = itemName, count = count }
    local ok, exported = pcall(function() return meBridge.exportItem(stack, chestSide) end)
    if not ok or exported == 0 then
        print("Failed to export " .. itemName)
        return 0
    end
    print("Exported " .. exported .. "x " .. itemName)
    return exported
end

local function isCraftable(itemName)
    local craftable = meBridge.listCraftableItems() or {}
    for _, i in ipairs(craftable) do
        if i.name == itemName then return true end
    end
    return false
end

local function craftItem(itemName, count)
    if not isCraftable(itemName) then
        print("Item not craftable: " .. itemName)
        return false
    end
    local ok, result = pcall(function() return meBridge.craftItem({ name = itemName, count = count }) end)
    if ok then
        print("Scheduled craft of " .. count .. "x " .. itemName)
        return true
    else
        print("Failed to craft " .. itemName .. ": " .. tostring(result))
        return false
    end
end

--------------------
-- Colony Integrator Helpers
--------------------
local function getRequests()
    return colony.getRequests() or {}
end

-- Filter requests to a single builder hut by name
local function getBuilderRequests(builderName)
    local all = getRequests()
    local builderReqs = {}
    for _, r in ipairs(all) do
        if r.target == builderName then
            table.insert(builderReqs, r)
        end
    end
    return builderReqs
end
