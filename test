-- Wrap peripherals
local colony_integrator = peripheral.wrap("top")  -- Integrator
local me_bridge = peripheral.wrap("bottom")       -- AE2 Bridge
local chest = peripheral.wrap("left")             -- Output chest

if not colony_integrator or not me_bridge or not chest then
    error("Missing required peripherals")
end

-- Helper: get AE2 current stock
local function getAE2Count(itemName)
    local count = 0
    local items = me_bridge.list()  -- returns table with keys as item names
    if items[itemName] then
        count = items[itemName].size or 0
    end
    return count
end

while true do
    local allRequests = colony_integrator.getRequests() or {}

    -- Collect Builder's Hut requests
    local builderRequests = {}
    for _, req in ipairs(allRequests) do
        if req.target == "Builder's Hut" then
            local itemName = req.items[1].name
            builderRequests[itemName] = (builderRequests[itemName] or 0) + req.count
        end
    end

    -- Process each requested item
    for itemName, totalNeeded in pairs(builderRequests) do
        local haveCount = 0
        -- get current AE2 count
        local aeItems = me_bridge.list() or {}
        for _, item in ipairs(aeItems) do
            if item.name == itemName then
                haveCount = item.count or 0
                break
            end
        end

        local missing = totalNeeded - haveCount
        if missing > 0 then
            -- Try to export missing amount to chest
            local exported = me_bridge.exportItem({name=itemName, count=missing}, "left")
            print("Exported", exported or 0, "of", itemName, "to chest")

            -- If AE2 didn't have enough, craft the remainder
            if exported < missing then
                local toCraft = missing - (exported or 0)
                local crafted = me_bridge.craftItem({name=itemName, count=toCraft})
                print("Craft requested for", toCraft, "of", itemName)
            end
        else
            print("AE2 has enough of", itemName, "(", haveCount, "available)")
        end
    end

    sleep(10)
end
