-- User Settings
local SCAN_INTERVAL = 10  -- seconds between scans when idle
local EXPORT_CHEST_SIDE = "front"  -- side of the chest relative to the computer
local MAX_DISTANCE = 5  -- only Builders Huts within 5 blocks

-- Peripherals
local colony_integrator = peripheral.find("colonyIntegrator") or error("No colony_integrator (top) found")
local me_bridge = peripheral.find("meBridge") or error("No me_bridge (bottom) found")
local chest = peripheral.wrap(EXPORT_CHEST_SIDE) or error("No chest detected on side " .. EXPORT_CHEST_SIDE)

-- Helper function to calculate distance (manhattan)
local function distance(pos1, pos2)
    return math.abs(pos1.x - pos2.x) + math.abs(pos1.y - pos2.y) + math.abs(pos1.z - pos2.z)
end

-- Export a requested item from ME Bridge into chest
local function exportItem(itemName, count)
    local ok, exported = pcall(function()
        return chest.pullItems(me_bridge, itemName, count)
    end)
    if not ok then
        print("Error exporting " .. itemName .. ": " .. tostring(exported))
        return 0
    end
    return exported or 0
end

-- Main loop
while true do
    local requests = {}
    local ok, allRequests = pcall(colony_integrator.getRequests)
    if ok and allRequests then
        -- Filter for Builders Huts within 5 blocks
        local compPos = {x=0, y=0, z=0}  -- default computer position (adjust if needed)
        for _, req in ipairs(allRequests) do
            local targetPos = req.targetPosition or {x=0, y=0, z=0}
            local dist = distance(compPos, targetPos)
            if dist <= MAX_DISTANCE and string.find(req.target, "Builder") then
                table.insert(requests, req)
            end
        end
    else
        print("Failed to get requests from colony_integrator")
    end

    -- Fulfill requests
    for _, req in ipairs(requests) do
        local itemName = req.items[1].name
        local needed = req.count
        local exported = exportItem(itemName, needed)
        print(string.format("Exported %d/%d of %s to chest", exported, needed, itemName))
    end

    -- Pause before next scan
    if #requests == 0 then
        sleep(SCAN_INTERVAL)
    else
        sleep(1) -- short pause between handling requests
    end
end
