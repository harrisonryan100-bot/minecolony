local colony_integrator = peripheral.wrap("top")  -- Integrator
local me_bridge = peripheral.wrap("bottom")       -- AE2 Bridge
local chest = peripheral.wrap("left")             -- Output chest

if not colony_integrator or not me_bridge or not chest then
    error("Missing required peripherals")
end

local function exportItemToChest(itemName, count)
    local exported = 0
    local ok, result = pcall(function()
        exported = me_bridge.exportItem({name=itemName, count=count}, "left")
    end)
    if not ok then
        print("Error exporting", itemName, "-", result)
        exported = 0
    end
    return exported
end

local function craftItem(itemName, count)
    local ok, result = pcall(function()
        return me_bridge.craftItem({name=itemName, count=count})
    end)
    if not ok then
        print("Error crafting", itemName, "-", result)
        return false
    end
    if result then
        print("Requested craft:", count, "x", itemName)
        return true
    end
    return false
end

while true do
    local allRequests = colony_integrator.getRequests() or {}

    -- Aggregate Builder's Hut requests
    local builderRequests = {}
    for _, req in ipairs(allRequests) do
        if req.target == "Builder's Hut" then
            local itemName = req.items[1].name
            builderRequests[itemName] = (builderRequests[itemName] or 0) + req.count
        end
    end

    -- Export and craft all items at once
    for itemName, totalCount in pairs(builderRequests) do
        local exported = exportItemToChest(itemName, totalCount)
        local remaining = totalCount - exported
        print("Exported", exported, "of", itemName, "remaining", remaining)

        if remaining > 0 then
            craftItem(itemName, remaining)
        end
    end

    sleep(10)
end
