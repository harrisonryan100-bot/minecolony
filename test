-- Wrap peripherals
local colony = peripheral.wrap("top")        -- Colony Integrator
local meBridge = peripheral.wrap("bottom")   -- ME Bridge
local chestSide = "back"                      -- Adjust this to where the chest is connected

if not colony then error("Colony Integrator not found on top") end
if not meBridge then error("ME Bridge not found on bottom") end
if not peripheral.isPresent(chestSide) then error("No chest detected on side " .. chestSide) end

-- Function to push items from AE2 into connected chest
local function pushItemToChest(itemName, count)
    local remaining = count
    while remaining > 0 do
        -- Create item stack
        local stack = { name = itemName, count = remaining }

        -- Attempt to pull from ME Bridge into chest
        local ok, pulled = pcall(meBridge.pushItem, meBridge, chestSide, stack)
        if ok and pulled and pulled > 0 then
            print("Pushed " .. pulled .. "x " .. itemName .. " to chest")
            remaining = remaining - pulled
        else
            print("Failed to push " .. itemName .. ", retrying...")
            sleep(1)
        end
    end
end

-- Example request processing
local requests = colony.getRequests() or {}
for _, req in ipairs(requests) do
    -- Only handle Builder Hut requests
    if req.target:find("Builder") and req.items and #req.items > 0 then
        local item = req.items[1].name
        local count = req.count or 1
        print("Attempting to send " .. count .. "x " .. item .. " to " .. req.target)
        pushItemToChest(item, count)
    end
end
