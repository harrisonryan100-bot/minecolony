-- Wrap peripherals
local colony_integrator = peripheral.wrap("top")
local me_bridge = peripheral.wrap("bottom")

if not colony_integrator then error("No Colony Integrator found on top!") end
if not me_bridge then error("No ME Bridge found on bottom!") end

local SCAN_INTERVAL = 10
local DEBUG = true

local function dprint(...)
    if DEBUG then
        print("[DEBUG]", ...)
    end
end

-- Try to export an item
local function exportItem(itemName, count)
    local stack = { name = itemName, count = count or 1 }
    local sides = {"top","bottom","left","right","front","back"}
    for _, side in ipairs(sides) do
        local ok, exported = pcall(function()
            return me_bridge.exportItem(stack, side)
        end)
        if ok and type(exported) == "number" and exported > 0 then
            dprint("Exported " .. exported .. " x " .. itemName .. " to side " .. side)
            return exported
        elseif not ok then
            dprint("Error exporting to side " .. side .. ": " .. tostring(exported))
        end
    end
    dprint("Failed to export " .. itemName)
    return 0
end

-- Main loop
while true do
    local requests = colony_integrator.getRequests()
    if not requests then
        dprint("No requests found")
    else
        for _, req in ipairs(requests) do
            local reqTarget = req.target or ""
            if string.find(reqTarget, "Ezra") then
                local reqItem = req.items[1].name
                local reqCount = req.count or 1
                dprint("Found request for Ezra: " .. reqCount .. " x " .. reqItem)
                
                local exported = exportItem(reqItem, reqCount)
                if exported < reqCount then
                    dprint("Could not fulfill full request, exported " .. exported)
                end
            end
        end
    end
    sleep(SCAN_INTERVAL)
end
