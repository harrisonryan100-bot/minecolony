------------------------------------------------------------
-- AE2 → Colony → Chest Exporter
-- Simplified working version
------------------------------------------------------------

-- CONFIG
local colonySide = "top"     -- side where Colony Integrator is
local chestSide  = "front"   -- side where a regular chest is placed
local meBridgeSide = "bottom" -- side where ME Bridge is attached
local SCAN_INTERVAL = 10
local DEBUG = true

-- WRAPPERS
local colony = peripheral.wrap(colonySide)
if not colony then error("No Colony Integrator found on side " .. colonySide) end

local chest = peripheral.wrap(chestSide)
if not chest then error("No chest found on side " .. chestSide) end

local meBridge = peripheral.wrap(meBridgeSide)
if not meBridge then error("No ME Bridge found on side " .. meBridgeSide) end

-- Logging helper
local function dprint(...)
    if DEBUG then print("[DEBUG]", ...) end
end

-- Get AE2 item count
local function getItemCount(itemName)
    local total = 0
    local ok, storage = pcall(function() return meBridge.listItems() end)
    if ok and storage then
        for _, item in ipairs(storage) do
            if item.name == itemName then
                total = total + (item.count or 0)
            end
        end
    else
        dprint("Failed to list items on ME Bridge")
    end
    return total
end

-- Export items to chest
local function exportToChest(itemName, count)
    local ok, result = pcall(function()
        return meBridge.exportItem({name=itemName, count=count}, chestSide)
    end)
    if ok then
        dprint(string.format("Attempted to export %d x %s: success=%s", count, itemName, tostring(result)))
        return result
    else
        dprint(string.format("Failed to export %s: %s", itemName, result))
        return 0
    end
end

-- Process builder requests
local function processRequests()
    local requests = colony.getRequests()
    if not requests or #requests == 0 then
        dprint("No requests found")
        return
    end

    for _, req in ipairs(requests) do
        local target = req.target or ""
        if string.find(target, "Builder") then
            local itemName = req.items[1] and req.items[1].name
            local reqCount = req.count or 1
            if not itemName then
                dprint("Cannot determine item for request: " .. req.name)
            else
                local available = getItemCount(itemName)
                if available <= 0 then
                    dprint("Not enough " .. itemName .. " in AE2")
                else
                    local toExport = math.min(reqCount, available)
                    local success = exportToChest(itemName, toExport)
                    if success > 0 then
                        dprint(string.format("Exported %d x %s to chest for %s", success, itemName, target))
                    else
                        dprint(string.format("Failed to export %s for %s", itemName, target))
                    end
                end
            end
        end
    end
end

-- MAIN LOOP
while true do
    processRequests()
    sleep(SCAN_INTERVAL)
end
