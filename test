-- Peripherals
local colony_integrator = peripheral.wrap("top")    -- Integrator on top
local me_bridge = peripheral.wrap("bottom")        -- ME Bridge on bottom
local chest = peripheral.find("minecraft:chest") or peripheral.find("minecraft:barrel")
if not chest then error("No chest or barrel found") end

-- Settings
local SCAN_INTERVAL = 10 -- seconds between scans

-- Helper to print debug
local function dprint(...)
    print("[DEBUG]", ...)
end

-- Export an item from ME Bridge to the chest
local function exportItemToChest(itemName, count)
    local itemStack = { name = itemName, count = count }
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        local ok, result = pcall(function()
            return me_bridge.exportItem(itemStack, side)
        end)
        if ok and type(result) == "number" and result > 0 then
            dprint("Exported " .. result .. "/" .. count .. " of " .. itemName .. " to side " .. side)
            return result
        end
    end
    dprint("Failed to export " .. itemName .. ": no output inventory found")
    return 0
end

-- Process requests for Ezra's Builder Hut
local function fulfillEzraRequests()
    if not colony_integrator.isInColony() then
        dprint("Colony integrator not in colony")
        return
    end

    local requests = colony_integrator.getRequests()
    if not requests then return end

    for _, req in ipairs(requests) do
        if req.target == "Builder Ezra P. Barrett" then
            local itemName = req.items[1].name
            local needed = req.count
            local exported = exportItemToChest(itemName, needed)
            if exported > 0 then
                print(string.format("Exported %d/%d of %s to chest", exported, needed, itemName))
            else
                print("Could not export " .. itemName)
            end
        end
    end
end

-- Main loop
while true do
    fulfillEzraRequests()
    sleep(SCAN_INTERVAL)
end
