--------------------
-- CONFIG
--------------------
local SCAN_INTERVAL = 10 -- seconds between scans when nothing is pending
local EXPORT_SIDE = "left" -- side where the chest is connected
local RANGE = 5 -- blocks from computer to Builders Huts

-- Top = colony integrator, Bottom = ME Bridge
local colony_integrator = peripheral.wrap("top")
local me_bridge = peripheral.wrap("bottom")
local chest = peripheral.wrap(EXPORT_SIDE)

if not colony_integrator then error("Colony Integrator not found on top") end
if not me_bridge then error("ME Bridge not found on bottom") end
if not chest then error("No chest/barrel found on " .. EXPORT_SIDE) end

--------------------
-- HELPERS
--------------------
local function normalizeName(name)
    local clean = name:match("([^:]+:[^:]+)")
    if clean then return clean else return name end
end

local function getNearbyBuilders()
    local huts = colony_integrator.getBuildings("buildersHut") or {}
    local nearby = {}
    local cx, cy, cz = table.unpack({gps.locate()}) -- get computer position
    for _, hut in ipairs(huts) do
        local hx, hy, hz = hut:getPosition()
        local dx, dy, dz = math.abs(cx - hx), math.abs(cy - hy), math.abs(cz - hz)
        if dx <= RANGE and dy <= RANGE and dz <= RANGE then
            table.insert(nearby, hut)
        end
    end
    return nearby
end

local function getRequestsForHut(hut)
    local requests = colony_integrator.getRequests(hut) or {}
    return requests
end

local function getAEItems()
    local items = me_bridge.listItems() or {}
    local aeItems = {}
    for _, i in ipairs(items) do
        local n = normalizeName(i.name)
        aeItems[n] = (aeItems[n] or 0) + (i.count or 0)
    end
    return aeItems
end

local function exportItemToChest(itemName, count)
    local pushed = chest.pullItems(me_bridge, itemName, count) -- pull from ME Bridge to chest
    return pushed or 0
end

--------------------
-- MAIN LOOP
--------------------
while true do
    local aeItems = getAEItems()
    local builders = getNearbyBuilders()
    local pending = false

    for _, hut in ipairs(builders) do
        local requests = getRequestsForHut(hut)
        for _, req in ipairs(requests) do
            local item = normalizeName(req.items[1].name)
            local needed = req.count
            local available = aeItems[item] or 0
            if available > 0 then
                local toExport = math.min(available, needed)
                local exported = exportItemToChest(item, toExport)
                print(string.format("Exported %d of %s to chest for %s", exported, item, hut:getOwnerName()))
                aeItems[item] = available - exported
                pending = true
            end
        end
    end

    if not pending then
        sleep(SCAN_INTERVAL)
    end
end
