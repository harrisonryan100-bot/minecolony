-- Wrap peripherals
local colony_integrator = peripheral.wrap("top")
if not colony_integrator then error("No colony_integrator found on top") end

local me_bridge = peripheral.wrap("bottom")
if not me_bridge then error("No me_bridge found on bottom") end

-- Safe export function: tries all sides until it works
local function safeExportItem(stack)
    local sides = {"top", "bottom", "left", "right", "front", "back"}
    for _, side in ipairs(sides) do
        local ok, exported = pcall(function()
            return me_bridge.exportItem(stack, side)
        end)
        if ok and exported > 0 then
            print("Exported " .. exported .. "x " .. stack.name .. " to side: " .. side)
            return exported
        end
    end
    print("Failed to export " .. stack.name .. ": no output inventory found")
    return 0
end

-- Main automation loop
while true do
    local allRequests = colony_integrator.getRequests() or {}
    print("Found " .. #allRequests .. " requests from colony")

    for _, req in ipairs(allRequests) do
        if req.target:find("Builder") and req.target:find("Ezra") then
            local itemName = req.items[1].name
            local countNeeded = req.count

            print("Attempting to fulfill request for " .. countNeeded .. "x " .. itemName .. " to Ezra's Builder Hut")

            local exported = safeExportItem({ name = itemName, count = countNeeded })
            print("Request result: " .. exported .. "/" .. countNeeded .. " exported")
        end
    end

    print("Cycle complete, waiting 10 seconds before next check...")
    sleep(10)
end
