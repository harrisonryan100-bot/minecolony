-- Wrap peripherals
local colony_integrator = peripheral.wrap("top")  -- integrator on top
local me_bridge        = peripheral.wrap("bottom") -- ME Bridge on bottom
local chest            = peripheral.wrap("back")   -- chest on back

if not colony_integrator then error("No Colony Integrator found on top!") end
if not me_bridge then error("No ME Bridge found on bottom!") end
if not chest then error("No chest found on back!") end

-- Export item helper
local function exportItem(itemName, count)
    local exported = me_bridge.exportItem({name=itemName, count=count}, "back")
    print("Exported", exported, "of", itemName)
    return exported
end

-- Return unrequested items
local function returnUnrequestedItems(requestedItems)
    local chestItems = chest.list() or {}
    for slot, item in pairs(chestItems) do
        if not requestedItems[item.name] then
            local returned = me_bridge.exportItem({name=item.name, count=item.count}, "back")
            print("Returned", returned, "of", item.name)
        end
    end
end

while true do
    local requests = colony_integrator.getRequests() or {}

    -- Only handle Builder's Hut requests
    local builderRequests = {}
    for _, req in ipairs(requests) do
        if req.target == "Builder's Hut" then
            local itemName = req.items[1].name
            builderRequests[itemName] = (builderRequests[itemName] or 0) + req.count
        end
    end

    -- Fulfill requests
    for itemName, count in pairs(builderRequests) do
        print("Requesting craft of", count, itemName)
        me_bridge.craftItem({name=itemName, count=count})
        sleep(1) -- short pause to let AE2 process
        exportItem(itemName, count)
    end

    -- Return unrequested items
    returnUnrequestedItems(builderRequests)

    sleep(10)
end
