local colony = peripheral.wrap("top")
local me = peripheral.wrap("bottom")

if not colony then error("Colony Integrator missing on top") end
if not me then error("ME Bridge missing on bottom") end

-- Get integrator position
local integratorPos = colony.getLocation()  -- {x=, y=, z=}

-- Distance helper
local function distance(a, b)
    local dx = a.x - b.x
    local dy = a.y - b.y
    local dz = a.z - b.z
    return math.sqrt(dx*dx + dy*dy + dz*dz)
end

-- Returns builder huts within 5 blocks
local function getNearbyBuilders()
    local nearby = {}
    local buildings = colony.getBuildings()

    if not buildings then return nearby end

    for _, b in pairs(buildings) do
        if b.type == "builder" and b.location then
            local dist = distance(integratorPos, b.location)
            if dist <= 5 then
                table.insert(nearby, b)
            end
        end
    end

    return nearby
end

-- Pull ALL requests from colony first
local function getAllRequests()
    local reqs = {}
    local all = colony.getRequests()

    if not all then return reqs end

    for _, r in pairs(all) do
        table.insert(reqs, r)
    end

    return reqs
end

-- Get requests specifically for Ezra (only nearby builders)
local function getEzraRequests()
    local nearbyBuilders = getNearbyBuilders()
    local allRequests = getAllRequests()
    local ezraReqs = {}

    for _, req in ipairs(allRequests) do
        for _, b in ipairs(nearbyBuilders) do
            if req.target == b.id or req.buildingId == b.id or req.builderId == b.id then
                table.insert(ezraReqs, req)
            end
        end
    end

    return ezraReqs
end

-- Main loop
while true do
    local ezraRequests = getEzraRequests()

    if #ezraRequests > 0 then
        print("Ezra has " .. #ezraRequests .. " requests nearby.")
        -- Process them hereâ€¦
    else
        print("No nearby Ezra requests. Scanning in 10 seconds...")
        sleep(10)
    end
end
