-- Wrap peripherals
local colony = peripheral.wrap("top")
local meBridge = peripheral.wrap("bottom")

-- Check peripherals
if not colony then
    print("ERROR: Colony Integrator NOT found on top")
    return
end
if not meBridge then
    print("ERROR: ME Bridge NOT found on bottom")
    return
end

print("Colony Integrator detected on top")
print("ME Bridge detected on bottom")

-- Detect a valid export side
local sides = {"top","bottom","left","right","front","back"}
local exportSide = nil
for _, side in ipairs(sides) do
    local ok, err = pcall(function()
        -- test with a dummy item; will fail silently if AE2 doesn't have it
        meBridge.exportItem({name="minecraft:stone", count=1}, side)
    end)
    if ok then
        exportSide = side
        break
    end
end

if not exportSide then
    print("ERROR: No valid inventory found next to ME Bridge")
    return
else
    print("Exporting items to side: "..exportSide)
end

-- Main loop: attempt to fulfill builder hut requests
while true do
    local requests = colony.getRequests() or {}
    
    for _, req in ipairs(requests) do
        -- Only process builder huts
        if req.target and req.target:match("Builder") and req.items and req.items[1] and req.items[1].name then
            local itemName = req.items[1].name
            local count = req.count or 1
            
            -- Attempt to export
            local ok, exported = pcall(function()
                return meBridge.exportItem({name=itemName, count=count}, exportSide)
            end)
            
            if ok then
                print(string.format("Attempted to export %d x %s to %s: success=%s", count, itemName, req.target, tostring(exported)))
            else
                print(string.format("Attempted to export %d x %s to %s: FAILED (%s)", count, itemName, req.target, tostring(exported)))
            end
        end
    end
    
    sleep(5) -- wait befor
