-- Settings
local ME_SIDE = "bottom"       -- side ME Bridge is on
local COLONY_SIDE = "top"      -- side Colony Integrator is on
local CHEST_SIDE = "front"     -- side chest to export items

-- Wrap peripherals
local meBridge = peripheral.wrap(ME_SIDE)
if not meBridge then error("No ME Bridge detected on " .. ME_SIDE) end

local colony = peripheral.wrap(COLONY_SIDE)
if not colony then error("No Colony Integrator detected on " .. COLONY_SIDE) end

-- Safe method to get items from ME Bridge
local function getMEItems()
    if type(meBridge.listItems) == "function" then
        return meBridge.listItems() or {}
    elseif type(meBridge.getItems) == "function" then
        return meBridge.getItems() or {}
    else
        error("ME Bridge has no listItems or getItems method")
    end
end

-- Move items to chest
local function moveToChest(itemName, count)
    local totalMoved = 0
    local items = getMEItems()
    for _, entry in ipairs(items) do
        if entry.name == itemName then
            local toMove = math.min(entry.count, count - totalMoved)
            local exported = meBridge.exportItem({name=itemName, count=toMove}, CHEST_SIDE)
            totalMoved = totalMoved + (exported or 0)
            print("Exported " .. (exported or 0) .. "x " .. itemName .. " to chest")
            if totalMoved >= count then break end
        end
    end
    return totalMoved
end

-- Main loop
while true do
    local requests = colony.getRequests() or {}
    print("Found " .. #requests .. " request(s)")
    for _, req in ipairs(requests) do
        if req.target:match("Builder") then
            local itemName = req.items[1].name
            local needed = req.count
            local available = 0
            for _, entry in ipairs(getMEItems()) do
                if entry.name == itemName then
                    available = entry.count
                    break
                end
            end
            if available >= needed then
                moveToChest(itemName, needed)
            else
                print("Not enough " .. itemName .. " in ME, skipping for now")
            end
        end
    end
    sleep(10)
end
