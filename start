------------------------------------------------------------
-- MineColonies AE2 Builder Automation
-- Fully integrated with Builder Hut requests
-- top = Colony Integrator
-- bottom = ME Bridge
-- Logs all activity to "automation_log.txt"
------------------------------------------------------------

local SCAN_INTERVAL = 5
local LOG_FILE = "automation_log.txt"
local CRAFT_TIMEOUT = 90
local MAX_ATTEMPTS = 3
local DEBUG = true

-- Track in-progress crafting
local craftingTracker = {}

-- Wrap peripherals
local colony = peripheral.wrap("top")
local meBridge = peripheral.wrap("bottom")

-- Logging helper
local function log(msg)
    local line = os.date("%H:%M:%S") .. " | " .. msg
    print(line)
    local f = fs.open(LOG_FILE, "a")
    if f then
        f.writeLine(line)
        f.close()
    end
end

-- Safe call wrapper
local function safeCall(periph, func, ...)
    if type(periph[func]) ~= "function" then
        log("Peripheral missing function: " .. func)
        return nil
    end
    local ok, res = pcall(periph[func], periph, ...)
    if not ok then
        log("Error calling " .. func .. ": " .. tostring(res))
        return nil
    end
    return res
end

-- Build current AE2 inventory counts
local function getAEInventory()
    local items = {}
    local all = safeCall(meBridge, "listItems") or {}
    for _, data in ipairs(all) do
        if data.name then
            items[data.name] = (items[data.name] or 0) + (data.count or 0)
        end
    end
    return items
end

-- Check if item is craftable
local function isCraftable(item)
    local craftables = safeCall(meBridge, "listCraftableItems") or {}
    for _, c in ipairs(craftables) do
        if c.name == item then return true end
    end
    return false
end

-- Attempt to craft an item
local function craftItem(item, count)
    if not isCraftable(item) then
        log("Cannot craft " .. item)
        return false
    end
    local ok = safeCall(meBridge, "craftItem", {name=item, count=count})
    if ok then
        craftingTracker[item] = {
            expected = count,
            timestamp = os.clock(),
            attempts = 1,
            timedOut = false,
            lastCount = 0
        }
        log("Requested craft of " .. count .. "x " .. item)
        return true
    end
    log("Failed to request craft for " .. item)
    return false
end

-- Export items to Builder Hut (top side of ME Bridge by default)
local function exportItem(item, count)
    local exported = safeCall(meBridge, "exportItem", {name=item, count=count}, "top")
    if exported and exported > 0 then
        log("Exported " .. exported .. "x " .. item .. " to Builder Hut")
        return exported
    else
        log("Failed to export " .. item)
        return 0
    end
end

-- Fulfill requests from Builder Hut only
local function processRequests()
    local allRequests = safeCall(colony, "getRequests") or {}
    if #allRequests == 0 then
        log("No requests in Colony Integrator")
        return
    end
    log("Found " .. #allRequests .. " request(s)")

    local aeInventory = getAEInventory()

    for _, req in ipairs(allRequests) do
        if string.find(req.target, "Builder") then
            local itemName = req.items[1] and req.items[1].name
            local count = req.count or 1

            if not itemName then
                log("Could not determine AE2 item for request: " .. req.name)
            else
                local available = aeInventory[itemName] or 0
                local provided = 0

                -- Export what is available
                if available > 0 then
                    local toExport = math.min(available, count)
                    provided = exportItem(itemName, toExport)
                    aeInventory[itemName] = available - provided
                end

                -- If still missing, attempt craft
                if provided < count then
                    local missing = count - provided
                    if isCraftable(itemName) then
                        local tracked = craftingTracker[itemName]
                        if not tracked or tracked.timedOut then
                            local success = craftItem(itemName, missing)
                            if success then
                                log("Scheduled craft for missing " .. missing .. "x " .. itemName)
                            end
                        else
                            log(itemName .. " craft in progress, waiting...")
                        end
                    else
                        log("Item not available and not craftable: " .. itemName)
                    end
                end

                -- If we provided all, complete request
                if provided >= count then
                    safeCall(colony, "completeRequest", req)
                    log("Request fulfilled: " .. itemName)
                else
                    log("Will retry request for Builder Hut next loop: " .. itemName)
                end
            end
        else
            -- Skip non-builder requests quietly
        end
    end
end

-- Main loop
while true do
    processRequests()
    sleep(SCAN_INTERVAL)
end
